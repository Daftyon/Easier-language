name: 🧪 Test Release Build

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-build:
    name: Test Build Process
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -e .

    - name: 🏗️ Test build
      shell: bash
      run: |
        # Create minimal example
        mkdir -p examples
        echo 'program test { show "Build test!"; }' > examples/test.el
        
        # Build executable  
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          python -m PyInstaller --onefile --name el-test --console --add-data "compiler;compiler" --add-data "utils;utils" --add-data "system;system" el_standalone.py
          ./dist/el-test.exe --version
        else
          python -m PyInstaller --onefile --name el-test --console --add-data "compiler:compiler" --add-data "utils:utils" --add-data "system:system" el_standalone.py  
          ./dist/el-test --version
        fi

    - name: ✅ Build Success
      run: echo "✅ Test build completed successfully on ${{ matrix.os }}"
